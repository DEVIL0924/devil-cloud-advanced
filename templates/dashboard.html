{% extends "layout.html" %}

{% block title %}Dashboard - DEVIL CLOUD{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Welcome, {{ username }}!</h1>
    <p>Manage your bots and monitor their performance</p>
</div>

<div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-section">
            <h3>Quick Actions</h3>
            <div class="sidebar-links">
                <a href="/upload" class="active">
                    <i class="fas fa-plus"></i> Upload New Bot
                </a>
                <a href="#" id="refresh-stats">
                    <i class="fas fa-sync-alt"></i> Refresh Stats
                </a>
                <a href="#" id="view-all-logs">
                    <i class="fas fa-file-alt"></i> View All Logs
                </a>
                <a href="/settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>System Status</h3>
            <div id="system-status">
                <div class="loading"></div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>Support</h3>
            <div class="sidebar-links">
                <a href="#"><i class="fas fa-book"></i> Documentation</a>
                <a href="#"><i class="fas fa-question-circle"></i> Help Center</a>
                <a href="#"><i class="fas fa-comments"></i> Community</a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Stats Grid -->
        <div class="stats-grid" id="stats-cards">
            <div class="stat-card">
                <div class="stat-header">
                    <h4>Running Bots</h4>
                    <div class="stat-icon running">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
                <div class="stat-value">{{ stats.running_bots|default(0) }}</div>
                <div class="stat-label">Active Processes</div>
                <div class="progress">
                    <div class="progress-bar cpu" style="width: {{ (stats.running_bots / stats.total_bots * 100 if stats.total_bots > 0 else 0)|round|int }}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h4>Total Bots</h4>
                    <div class="stat-icon total">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="stat-value">{{ stats.total_bots|default(0) }}</div>
                <div class="stat-label">Uploaded Files</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h4>Total Users</h4>
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stat-value">{{ users_count }}</div>
                <div class="stat-label">Registered Accounts</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h4>System Uptime</h4>
                    <div class="stat-icon cpu">
                        <i class="fas fa-server"></i>
                    </div>
                </div>
                <div class="stat-value" id="uptime">--</div>
                <div class="stat-label">Days:Hours:Minutes</div>
            </div>
        </div>

        <!-- Bots Section -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Your Bots</h2>
                <div>
                    <span class="badge">{{ bots|length }} bot(s)</span>
                </div>
            </div>
            
            {% if bots %}
            <div class="bots-grid">
                {% for bot in bots %}
                <div class="bot-card fade-in">
                    <div class="bot-header">
                        <h3 class="bot-name">{{ bot.name }}</h3>
                        <span class="bot-status status-{{ bot.status }}">
                            <i class="fas fa-circle"></i> {{ bot.status|upper }}
                        </span>
                    </div>
                    
                    <div class="bot-info">
                        <div class="bot-language">
                            <i class="fab fa-{{ 'python' if bot.language == 'python' else 'php' if bot.language == 'php' else 'js' if bot.language == 'node' else 'terminal' }}"></i>
                            <span class="language-badge language-{{ bot.language }}">
                                {{ bot.language|upper }}
                            </span>
                        </div>
                        <div class="bot-created">
                            <i class="far fa-calendar"></i>
                            {{ bot.created_at[:10] }}
                        </div>
                    </div>
                    
                    {% if bot.status == 'running' %}
                    <div class="mb-3">
                        <div class="mb-1">
                            <small>CPU: {{ "%.1f"|format(bot.cpu_usage) }}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar cpu" style="width: {{ bot.cpu_usage }}%"></div>
                        </div>
                        
                        <div class="mb-1 mt-2">
                            <small>Memory: {{ "%.1f"|format(bot.memory_usage) }} MB</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar memory" style="width: {{ (bot.memory_usage / 100) }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="bot-actions">
                        {% if bot.status == 'stopped' %}
                        <a href="/start/{{ bot.id }}" class="btn btn-sm btn-success">
                            <i class="fas fa-play"></i> Start
                        </a>
                        {% else %}
                        <a href="/stop/{{ bot.id }}" class="btn btn-sm btn-warning">
                            <i class="fas fa-stop"></i> Stop
                        </a>
                        <a href="/restart/{{ bot.id }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-redo"></i> Restart
                        </a>
                        {% endif %}
                        
                        <a href="/logs/{{ bot.id }}" class="btn btn-sm btn-outline">
                            <i class="fas fa-file-alt"></i> Logs
                        </a>
                        
                        <a href="/delete/{{ bot.id }}" 
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to delete this bot?')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center p-5">
                <div class="mb-4">
                    <i class="fas fa-robot fa-4x text-muted"></i>
                </div>
                <h3 class="mb-2">No Bots Found</h3>
                <p class="text-muted mb-4">Upload your first bot to get started!</p>
                <a href="/upload" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload"></i> Upload Your First Bot
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">System Information</h2>
                <button class="btn btn-sm btn-outline" id="refresh-system-info">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="row" id="system-info">
                <!-- Will be populated by JavaScript -->
                <div class="loading"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update uptime display
function updateUptime() {
    const startTime = new Date("{{ stats.uptime }}");
    const now = new Date();
    const diff = now - startTime;
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    document.getElementById('uptime').textContent = 
        `${days}d ${hours}h ${minutes}m`;
}

// Load system stats
async function loadSystemStats() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (data.system) {
            const systemInfo = document.getElementById('system-info');
            systemInfo.innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h4>CPU Usage</h4>
                            <div class="stat-icon cpu">
                                <i class="fas fa-microchip"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.system.cpu.toFixed(1)}%</div>
                        <div class="stat-label">${data.system.cpu < 50 ? 'Normal' : 'High'} Load</div>
                        <div class="progress mt-2">
                            <div class="progress-bar cpu" style="width: ${data.system.cpu}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h4>Memory</h4>
                            <div class="stat-icon running">
                                <i class="fas fa-memory"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.system.memory_percent.toFixed(1)}%</div>
                        <div class="stat-label">${Math.round(data.system.memory_used)} MB / ${Math.round(data.system.memory_total)} MB</div>
                        <div class="progress mt-2">
                            <div class="progress-bar memory" style="width: ${data.system.memory_percent}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h4>Disk Space</h4>
                            <div class="stat-icon total">
                                <i class="fas fa-hdd"></i>
                            </div>
                        </div>
                        <div class="stat-value">${data.system.disk_percent.toFixed(1)}%</div>
                        <div class="stat-label">${data.system.disk_used} GB / ${data.system.disk_total} GB</div>
                        <div class="progress mt-2">
                            <div class="progress-bar disk" style="width: ${data.system.disk_percent}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h4>Uptime</h4>
                            <div class="stat-icon users">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value">${Math.floor(data.system.uptime / 3600)}h</div>
                        <div class="stat-label">${Math.floor((data.system.uptime % 3600) / 60)}m ${data.system.uptime % 60}s</div>
                    </div>
                </div>
            `;
            
            // Update stats cards
            document.querySelectorAll('.stat-value')[0].textContent = data.running_bots;
            document.querySelectorAll('.stat-value')[1].textContent = data.total_bots;
            
            // Update progress bars
            const runningPercent = data.total_bots > 0 ? (data.running_bots / data.total_bots * 100) : 0;
            document.querySelector('.progress-bar.cpu').style.width = runningPercent + '%';
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    updateUptime();
    loadSystemStats();
    
    // Refresh stats every 30 seconds
    setInterval(loadSystemStats, 30000);
    
    // Manual refresh buttons
    document.getElementById('refresh-stats').addEventListener('click', function(e) {
        e.preventDefault();
        loadSystemStats();
    });
    
    document.getElementById('refresh-system-info').addEventListener('click', function(e) {
        e.preventDefault();
        loadSystemStats();
    });
    
    // Update uptime every minute
    setInterval(updateUptime, 60000);
});
</script>
{% endblock %}
